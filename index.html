<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"></script>
    <style>
      body {
        margin-top: 100px;
        margin-left: 100px;
      }
      .row {
        display: flex;
        flex-direction: row;
      }

      .cell {
        width: 40px;
        height: 40px;
        border: 1px solid;
      }

      .empty {
        background-color: #ccc !important;
      }

      .goal {
        background-color: black;
      }

      .fail {
        background-color: red;
      }
    </style>
  </head>

  <body>
    <div class="row">
      <div id="cell-0-0" class="cell"></div>
      <div id="cell-0-1" class="cell"></div>
      <div id="cell-0-2" class="cell"></div>
      <div id="cell-0-3" class="cell"></div>
      <div id="cell-0-4" class="cell"></div>
      <div id="cell-0-5" class="cell"></div>
      <div id="cell-0-6" class="cell"></div>
      <div id="cell-0-7" class="cell"></div>
      <div id="cell-0-8" class="cell"></div>
      <div id="cell-0-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-1-0" class="cell"></div>
      <div id="cell-1-1" class="cell"></div>
      <div id="cell-1-2" class="cell"></div>
      <div id="cell-1-3" class="cell"></div>
      <div id="cell-1-4" class="cell"></div>
      <div id="cell-1-5" class="cell"></div>
      <div id="cell-1-6" class="cell"></div>
      <div id="cell-1-7" class="cell"></div>
      <div id="cell-1-8" class="cell"></div>
      <div id="cell-1-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-2-0" class="cell"></div>
      <div id="cell-2-1" class="cell"></div>
      <div id="cell-2-2" class="cell"></div>
      <div id="cell-2-3" class="cell"></div>
      <div id="cell-2-4" class="cell"></div>
      <div id="cell-2-5" class="cell"></div>
      <div id="cell-2-6" class="cell"></div>
      <div id="cell-2-7" class="cell"></div>
      <div id="cell-2-8" class="cell"></div>
      <div id="cell-2-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-3-0" class="cell"></div>
      <div id="cell-3-1" class="cell"></div>
      <div id="cell-3-2" class="cell"></div>
      <div id="cell-3-3" class="cell"></div>
      <div id="cell-3-4" class="cell"></div>
      <div id="cell-3-5" class="cell"></div>
      <div id="cell-3-6" class="cell"></div>
      <div id="cell-3-7" class="cell"></div>
      <div id="cell-3-8" class="cell"></div>
      <div id="cell-3-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-4-0" class="cell"></div>
      <div id="cell-4-1" class="cell"></div>
      <div id="cell-4-2" class="cell"></div>
      <div id="cell-4-3" class="cell"></div>
      <div id="cell-4-4" class="cell"></div>
      <div id="cell-4-5" class="cell"></div>
      <div id="cell-4-6" class="cell"></div>
      <div id="cell-4-7" class="cell"></div>
      <div id="cell-4-8" class="cell"></div>
      <div id="cell-4-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-5-0" class="cell"></div>
      <div id="cell-5-1" class="cell"></div>
      <div id="cell-5-2" class="cell"></div>
      <div id="cell-5-3" class="cell"></div>
      <div id="cell-5-4" class="cell"></div>
      <div id="cell-5-5" class="cell"></div>
      <div id="cell-5-6" class="cell"></div>
      <div id="cell-5-7" class="cell"></div>
      <div id="cell-5-8" class="cell"></div>
      <div id="cell-5-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-6-0" class="cell"></div>
      <div id="cell-6-1" class="cell"></div>
      <div id="cell-6-2" class="cell"></div>
      <div id="cell-6-3" class="cell"></div>
      <div id="cell-6-4" class="cell"></div>
      <div id="cell-6-5" class="cell"></div>
      <div id="cell-6-6" class="cell"></div>
      <div id="cell-6-7" class="cell"></div>
      <div id="cell-6-8" class="cell"></div>
      <div id="cell-6-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-7-0" class="cell"></div>
      <div id="cell-7-1" class="cell"></div>
      <div id="cell-7-2" class="cell"></div>
      <div id="cell-7-3" class="cell"></div>
      <div id="cell-7-4" class="cell"></div>
      <div id="cell-7-5" class="cell"></div>
      <div id="cell-7-6" class="cell"></div>
      <div id="cell-7-7" class="cell"></div>
      <div id="cell-7-8" class="cell"></div>
      <div id="cell-7-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-8-0" class="cell"></div>
      <div id="cell-8-1" class="cell"></div>
      <div id="cell-8-2" class="cell"></div>
      <div id="cell-8-3" class="cell"></div>
      <div id="cell-8-4" class="cell"></div>
      <div id="cell-8-5" class="cell"></div>
      <div id="cell-8-6" class="cell"></div>
      <div id="cell-8-7" class="cell"></div>
      <div id="cell-8-8" class="cell"></div>
      <div id="cell-8-9" class="cell"></div>
    </div>

    <div class="row">
      <div id="cell-9-0" class="cell"></div>
      <div id="cell-9-1" class="cell"></div>
      <div id="cell-9-2" class="cell"></div>
      <div id="cell-9-3" class="cell"></div>
      <div id="cell-9-4" class="cell"></div>
      <div id="cell-9-5" class="cell"></div>
      <div id="cell-9-6" class="cell"></div>
      <div id="cell-9-7" class="cell"></div>
      <div id="cell-9-8" class="cell"></div>
      <div id="cell-9-9" class="cell"></div>
    </div>

    <div id="result"></div>

    <button id="stopBtn">stop</button>
    <script>
      // 0 : empty 1: goal -1: fail 2: semi_goal 3: prob
      let data_table = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      ];

      let snakes = [];
      let goal_pos = undefined;
      let obstacles = [];
      let start = false;

      function register_new_player() {
        if (snakes.length === 0) {
          goal_pos = getRandPos(1);

          for (let i = 0; i < 18; i++) {
            obstacles.push(getRandPos(-1));
          }
        }

        let id = Math.floor(Math.random() * 1000000);
        let color = Math.floor(Math.random() * 16777215).toString(16);
        let pos = getRandPos(0);

        snakes.push({
          id: id,
          last_move: undefined,
          pos: pos,
          color: color,
          point: 0,
        });

        render_map();
        if (snakes.length === 1) {
          start = true;
        }

        return [id, color, pos];
      }

      function getRandPos(fill_with) {
        let pos = {
          x: Math.floor(Math.random() * 9),
          y: Math.floor(Math.random() * 9),
        };

        while (
          data_table[pos.x][pos.y] !== 0 ||
          snakes.find(elem => elem.pos.x === pos.x && elem.pos.y === pos.y) !==
            undefined
        ) {
          pos = {
            x: Math.floor(Math.random() * 9),
            y: Math.floor(Math.random() * 9),
          };
        }

        data_table[pos.x][pos.y] = fill_with;

        return pos;
      }

      function render_map() {
        $('.cell').removeClass('goal').removeClass('fail').removeClass('empty');

        for (let i = 0; i < 10; i++) {
          for (let j = 0; j < 10; j++) {
            let selectedColor = undefined;

            snakes.forEach((elem, index) => {
              if (elem.pos.x === i && elem.pos.y === j)
                selectedColor = elem.color;
            });

            if (selectedColor !== undefined)
              $('#cell-' + i + '-' + j).css('background-color', selectedColor);
            else if (data_table[i][j] === 1)
              $('#cell-' + i + '-' + j).addClass('goal');
            else if (data_table[i][j] === -1)
              $('#cell-' + i + '-' + j).addClass('fail');
            else $('#cell-' + i + '-' + j).addClass('empty');
          }
        }
      }

      function move(id, direction) {
        if (!start) return false;

        let selectedIdx;

        let snake = snakes.find((elem, index) => {
          if (elem.id === id) {
            selectedIdx = index;
            return true;
          }
          return false;
        });

        if (snake === undefined) return;

        var curr = new Date().getTime();

        if (snake.last_move !== undefined && curr - snake.last_move < 1000) {
          return false;
        }

        snake.last_move = curr;

        // console.log(snake);
        // console.log(direction);

        if (direction === 'up') snake.pos.x = snake.pos.x - 1;
        else if (direction === 'down') snake.pos.x = snake.pos.x + 1;
        else if (direction === 'left') snake.pos.y = snake.pos.y - 1;
        else if (direction === 'right') snake.pos.y = snake.pos.y + 1;

        if (
          snake.pos.x < 0 ||
          snake.pos.x > 9 ||
          snake.pos.y < 0 ||
          snake.pos.y > 9
        ) {
          snakes.splice(selectedIdx, 1);
          $('#result').append('<h1>' + snake.id + ' loose</h1>');
          return;
        }

        let fail = false;

        obstacles.forEach((elem, index) => {
          if (elem.x === snake.pos.x && elem.y === snake.pos.y) fail = true;
        });

        if (fail) {
          console.log(snake.pos);
          snakes.splice(selectedIdx, 1);
          $('#result').append('<h1>' + snake.id + ' loose</h1>');
          return;
        }

        if (goal_pos.x === snake.pos.x && goal_pos.y === snake.pos.y) {
          snake.point += 10;
          data_table[goal_pos.x][goal_pos.y] = 0;
          goal_pos = getRandPos(1);
        }
        render_map();
        return true;
      }

      $(document).ready(function () {
        $('#stopBtn').on('click', function () {
          start = false;
        });
      });
    </script>

    <script src="./myAlgo.js"></script>
  </body>
</html>
